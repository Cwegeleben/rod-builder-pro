# fly.toml app configuration file generated for global-compliance-app on 2025-02-28T18:07:00+01:00
#
# See https://fly.io/docs/reference/configuration/ for information about how to use this file.
#

app = 'rbp-app'
primary_region = 'sjc'

[build]
  [build.args]
    # <!-- BEGIN RBP GENERATED: importer-discover-headless-harden-v1 -->
    # Enable Playwright Chromium installation in the image for headless discovery on Fly
    INSTALL_PLAYWRIGHT = "true"
    # <!-- END RBP GENERATED: importer-discover-headless-harden-v1 -->

[env]
  PORT = '3000'
  HOST = '0.0.0.0'
  # Persist Prisma SQLite database on the mounted volume
  DATABASE_URL = 'file:/data/dev.sqlite'
  SCOPES = 'write_products,read_metaobjects,write_metaobjects,read_metaobject_definitions,write_metaobject_definitions'
  SHOPIFY_APP_URL = 'https://rbp-app.fly.dev'
  ENABLE_SMOKES = 'true'
  SMOKE_TOKEN = 'smoke-ok'
  # Allow any dev HQ shop to access HQ-gated routes; tighten to exact bare if desired via HQ_SHOPS
  HQ_SHOPS_REGEX = '^rbp-hq.*dev.*$'
  # Temporarily allow HQ override via URL (?hq=1), cookie (rbp_hq=1), or header (x-hq-override: 1)
  # This enables direct access to debugging/status endpoints outside the embedded Admin during troubleshooting
  ALLOW_HQ_OVERRIDE = '1'
  # Cap V8 old space for a 2GB machine (leave ~25% native overhead)
  NODE_OPTIONS = '--max-old-space-size=1536'
  # Help Crawlee detect available memory correctly in containerized env
  CRAWLEE_MEMORY_MBYTES = '1536'
  # <!-- BEGIN RBP GENERATED: importer-discover-headless-harden-v1 -->
  PLAYWRIGHT_AVAILABLE = '1'
  # <!-- END RBP GENERATED: importer-discover-headless-harden-v1 -->

[processes]
  app = 'scripts/start-production.sh'

[[mounts]]
  source = 'data'
  destination = '/data'
  auto_extend_size_threshold = 80
  auto_extend_size_increment = '1GB'
  auto_extend_size_limit = '10GB'

[http_service]
  internal_port = 3000
  force_https = true
  # Keep machine warm to avoid cold starts and failed early health checks
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1
  processes = ['app']
  [[http_service.checks]]
    interval = '15s'
    timeout = '3s'
    grace_period = '30s'
    method = 'GET'
    path = '/resources/health'
    protocol = 'http'
    tls_skip_verify = false

[vm]
  memory = '2gb'
  cpu_kind = 'shared'
  cpus = 1
